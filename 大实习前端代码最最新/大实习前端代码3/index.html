<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <script src="https://cdn.jsdelivr.net/npm/geotiff"></script>

    <script src="https://cdn.jsdelivr.net/npm/ol@v10.6.0/dist/ol.js"></script>
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/ol@v10.6.0/ol.css"
    />
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>云南省植被覆盖度监测系统</title>
    <link rel="stylesheet" href="css/style.css" />
    <script src="lib\echarts.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/papaparse@5.3.0/papaparse.min.js"></script>
    <script src="js/tempRainfall.js"></script>
    <script src="js/coveragePieChart.js"></script>

</head>
<body>
    <div class="container">
      <header>
        <h1>云南省植被覆盖度监测系统</h1>
        <nav>
          <ul>
            <li><a href="index.html" class="active">云南省概况</a></li>
            <li><a href="变化检测.html">变化监测</a></li>
            <li><a href="模型预测.html">模型预测</a></li>
            <li><a href="帮助文档.html">帮助与支持文档</a></li>
          </ul>
        </nav>
        <div class="user-controls">
          <a href="#" id="loginBtn">登录</a>|<a href="#" id="registerBtn"
            >注册</a
          >
        </div>
      </header>

      <main>
        <div class="left-section">
          <div class="panel-left1">
            <div class="filter-group">
              <label>数据类型：</label>
              <div class="select-wrapper">
                <select id="dataType">
                  <option value="1">植被覆盖度</option>
                  <option value="2">地形</option>
                  <option value="3">植被类型</option>
                  <option value="4">地貌类型</option>
                </select>
              </div>
            </div>
            <div class="filter-group">
              <label>区域范围：</label>
              <div class="select-group">
                <select id="province-select" name="province">
                  <option value="530000">云南省</option>
                </select>
                <select id="city-select" name="city">
                  <option value="">市</option>
                  <option value="530100">昆明市</option>
                  <option value="530300">曲靖市</option>
                  <option value="530400">玉溪市</option>
                  <option value="530500">保山市</option>
                  <option value="530600">昭通市</option>
                  <option value="530700">丽江市</option>
                  <option value="530800">普洱市</option>
                  <option value="530900">临沧市</option>
                  <option value="532300">楚雄彝族自治州</option>
                  <option value="532500">红河哈尼族彝族自治州</option>
                  <option value="532600">文山壮族苗族自治州</option>
                  <option value="532800">西双版纳傣族自治州</option>
                  <option value="532900">大理白族自治州</option>
                  <option value="533100">德宏傣族景颇族自治州</option>
                  <option value="533300">怒江傈僳族自治州</option>
                  <option value="533400">迪庆藏族自治州</option>
                </select>

                <select id="county-select" name="county">
                  <option value="">县</option>
                  <!-- 县级选项将通过JavaScript动态填充 -->
                </select>

                <button id="region-search-btn" class="search-btn">搜索</button>
              </div>
            </div>
          </div>

          <div class="panel-left2">
            <div class="chartl1">
              <h3>云南省不同等级植被覆盖度面积</h3>
              <div id="coveragePieChart"></div>
            </div>
            <div class="chartl2">
              <h3>云南省平均植被覆盖度</h3>
              <div id="regionBarChart"></div>
            </div>
          </div>
        </div>

        <div class="center-section">
          <div id="yunnanMap" class="map"></div>
          <div class="timeline-control">
            <input
              type="range"
              id="timeSlider"
              min="2013"
              max="2022"
              value="2020"
              step="1"
            />
            <div class="time-label">2020年</div>
          </div>
        </div>

        <div class="right-section">
          <div class="panel-right">
            <div class="chart-right">
              <h3>云南省十年温度变化和降水量</h3>
              <div
                id="tempRainfallChart"
                style="width: 100%; height: 250px"
              ></div>
              <h3>云南省十年平均植被覆盖度</h3>
              <div id="coverageLineChart"></div>
            </div>
            <div class="chart">
              
            </div>
          </div>
        </div>
      </main>
    </div>

    <!-- 登录弹窗 -->
    <div class="modal" id="loginModal">
      <div class="modal-content">
        <span class="close-btn">&times;</span>
        <h2>
          云南省植被覆盖度监测系统<br /><span class="en-title"
            >Vegetation coverage detection system in Yunnan Province</span
          >
        </h2>

        <div class="login-form">
          <div class="form-group">
            <span class="icon user-icon"></span>
            <input type="text" id="loginEmail" placeholder="邮箱或电话号码" />
          </div>
          <div class="form-group">
            <span class="icon lock-icon"></span>
            <input type="password" id="loginPassword" placeholder="密码" />
          </div>
          <div class="form-group captcha">
            <span class="icon info-icon"></span>
            <input type="text" id="loginCaptcha" placeholder="验证码" />
            <div class="captcha-img"></div>
          </div>

          <div class="form-options">
            <div class="remember-me">
              <input type="checkbox" id="rememberMe" />
              <label for="rememberMe">30天内免登录</label>
            </div>
            <a href="#" class="forgot-pwd">重置密码</a>
          </div>

          <button class="btn login-btn">登录</button>
          <a href="#" class="register-link">注册</a>
        </div>
      </div>
    </div>

    <!-- 注册弹窗 -->
    <div class="modal" id="registerModal">
      <div class="modal-content">
        <span class="close-btn">&times;</span>
        <h2>
          云南省植被覆盖度监测系统<br /><span class="en-title"
            >Vegetation coverage detection system in Yunnan Province</span
          >
        </h2>

        <div class="register-form">
          <div class="form-group">
            <span class="icon user-icon"></span>
            <input type="text" id="regUsername" placeholder="用户名" />
          </div>
          <div class="form-group">
            <span class="icon email-icon"></span>
            <input
              type="email"
              id="regEmail"
              placeholder="输入邮箱或电话号码"
            />
          </div>
          <div class="form-group">
            <span class="icon lock-icon"></span>
            <input type="password" id="regPassword" placeholder="输入新密码" />
          </div>
          <div class="form-group captcha">
            <span class="icon info-icon"></span>
            <input type="text" id="regCaptcha" placeholder="验证码" />
            <div class="captcha-img"></div>
          </div>

          <button class="btn reset-pwd-btn">重置密码</button>
        </div>
      </div>
    </div>

    <script src="js/main.js"></script>
    <script src="js/charts.js"></script>
    <script src="js/map.js"></script>

    <script>
    window.addEventListener("load", function () {
      try {
        // 全局变量
        let map, osmLayer, currentTifLayer;
        const minYear = 2013;
        const maxYear = 2022;
        
        // 申请到的 Key
        const tk = '0d87f3bc5677c5772347eefc6201a0c1';

        // 1. 天地图矢量底图
        const tianditu_vec = new ol.layer.Tile({
          source: new ol.source.XYZ({
            url: `https://t0.tianditu.gov.cn/vec_w/wmts?SERVICE=WMTS&REQUEST=GetTile&VERSION=1.0.0&LAYER=vec&STYLE=default&TILEMATRIXSET=w&FORMAT=tiles&TILEMATRIX={z}&TILEROW={y}&TILECOL={x}&tk=${tk}`,
            crossOrigin: 'anonymous'
          })
        });

        // 2. 天地图矢量注记（可选，放文字/道路）
        const tianditu_cva = new ol.layer.Tile({
          source: new ol.source.XYZ({
            url: `https://t0.tianditu.gov.cn/cva_w/wmts?SERVICE=WMTS&REQUEST=GetTile&VERSION=1.0.0&LAYER=cva&STYLE=default&TILEMATRIXSET=w&FORMAT=tiles&TILEMATRIX={z}&TILEROW={y}&TILECOL={x}&tk=${tk}`,
            crossOrigin: 'anonymous'
          })
        });

        // 3. 影像底图（如需卫星影像，把 vec 换成 img）
        const tianditu_img = new ol.layer.Tile({
          source: new ol.source.XYZ({
            url: `https://t0.tianditu.gov.cn/img_w/wmts?SERVICE=WMTS&REQUEST=GetTile&VERSION=1.0.0&LAYER=img&STYLE=default&TILEMATRIXSET=w&FORMAT=tiles&TILEMATRIX={z}&TILEROW={y}&TILECOL={x}&tk=${tk}`,
            crossOrigin: 'anonymous'
          })
        });

        // ====== 2. 地图实例 ======
        map = new ol.Map({
          target: "yunnanMap",
          layers: [tianditu_vec, tianditu_cva],
          view: new ol.View({
            center: ol.proj.fromLonLat([102.7, 25]),
            zoom: 6,
          }),
        });
        
        // ====== 3. 加载初始年份数据 ======
        const initialYear = "2020";
        loadVegetationLayer(initialYear);
        
        // ====== 4. 时间滑块事件监听 ======
        const timeSlider = document.getElementById("timeSlider");
        const timeLabel = document.querySelector(".time-label");
        
        timeSlider.addEventListener("input", function () {
          const year = this.value;
          timeLabel.textContent = `${year}年`;
          loadVegetationLayer(year);
        });

        // ====== 5. 植被图层加载函数 ======
        function loadVegetationLayer(year) {
          // 移除现有植被图层
          if (currentTifLayer) {
            map.removeLayer(currentTifLayer);
          }
          
          // 创建新图层
          const tifPath = `tif/${year}fvc.tif`;
          
          try {
            currentTifLayer = new ol.layer.WebGLTile({
              source: new ol.source.GeoTIFF({
                sources: [
                  {
                    url: tifPath,
                    crossOrigin: "anonymous",
                    nodata: 0,
                  },
                ],
                normalize: false,
              }),
              style: {
                color: [
                  "interpolate",
                  ["linear"],
                  ["band", 1],
                  0, [0, 0, 0, 0],      // 透明
                  0.2, [215, 25, 28, 1], // 红色
                  0.4, [253, 174, 97, 1], // 橙色
                  0.6, [171, 217, 233, 1], // 浅蓝色
                  0.8, [44, 123, 182, 1], // 蓝色
                  1.0, [0, 68, 27, 1]     // 深绿色
                ]
              },
              opacity: 1,
            });

            // 添加到地图
            map.addLayer(currentTifLayer);
            
            // 错误处理
            currentTifLayer.getSource().on("error", (error) => {
              console.error("TIFF加载失败:", error);
              document.getElementById("yunnanMap").innerHTML = `
                <div class="map-error">
                  <p>${year}年植被数据加载失败</p>
                  <p>${error.message}</p>
                  <p>请检查文件路径: ${tifPath}</p>
                </div>
              `;
            });

            // 自适应视图（可选）
            currentTifLayer
              .getSource()
              .getView()
              .then((extent) => {
                map.getView().fit(extent, { padding: [20, 20, 20, 20] });
              })
              .catch((error) => {
                console.warn("无法获取图层范围:", error);
              });
              
          } catch (error) {
            console.error("创建图层失败:", error);
            document.getElementById("yunnanMap").innerHTML = `
              <div class="map-error">
                <p>创建${year}年植被图层失败</p>
                <p>${error.message}</p>
              </div>
            `;
          }
        }
        
        /* --------- 区域联动：市-县矢量图层与缩放 --------- */
        // 1. 缓存矢量图层实例
        let cityVectorLayer = null;
        let countyVectorLayer = null;

        // 2. 获取下拉框
        const citySelect = document.getElementById('city-select');
        const countySelect = document.getElementById('county-select');

        // 3. 全局范围（云南省）
        const yunnanExtent = ol.proj.transformExtent(
          [97.5, 21.0, 106.2, 29.5], 
          'EPSG:4326', 
          'EPSG:3857'
        );

        // 4. 工具函数：加载矢量图层
        function loadVectorLayer(path, layerType = 'city') {
          // 移除旧图层
          if (layerType === 'city' && cityVectorLayer) {
            map.removeLayer(cityVectorLayer);
            cityVectorLayer = null;
          }
          if (layerType === 'county' && countyVectorLayer) {
            map.removeLayer(countyVectorLayer);
            countyVectorLayer = null;
          }
          
          if (!path) return null;
          
          const isCounty = layerType === 'county';
          const vectorLayer = new ol.layer.Vector({
            source: new ol.source.Vector({
              url: path,
              format: new ol.format.GeoJSON(),
            }),
            style: new ol.style.Style({
              stroke: new ol.style.Stroke({
                color: isCounty ? '#00a000' : '#ff0000', // 县绿色，市红色
                width: 2
              }),
              fill: new ol.style.Fill({
                color: isCounty
                  ? 'rgba(0,160,0,0.15)'   // 县淡绿色
                  : 'rgba(255,0,0,0.1)'    // 市淡红色
              })
            }),
            zIndex: 9999
          });

          map.addLayer(vectorLayer);
          
          // 缩放到图层范围
          vectorLayer.getSource().once('change', function() {
            try {
              if (this.getFeatures().length > 0) {
                const extent = this.getExtent();
                if (extent && extent[0] !== Infinity) {
                  map.getView().fit(extent, {
                    padding: [50, 50, 50, 50],
                    duration: 600
                  });
                }
              }
            } catch (error) {
              console.warn("缩放矢量图层失败:", error);
            }
          });
          
          if (layerType === 'city') cityVectorLayer = vectorLayer;
          if (layerType === 'county') countyVectorLayer = vectorLayer;
          
          return vectorLayer;
        }

        // 5. 监听市变化
        citySelect.addEventListener('change', () => {
          const cityValue = citySelect.value;
          const cityName = citySelect.options[citySelect.selectedIndex].text.trim();
          
          // 重置县下拉框
          countySelect.innerHTML = '<option value="">县</option>';
          
          if (!cityValue) {
            // 市为空 -> 全局
            if (cityVectorLayer) map.removeLayer(cityVectorLayer);
            if (countyVectorLayer) map.removeLayer(countyVectorLayer);
            cityVectorLayer = countyVectorLayer = null;
            
            map.getView().fit(yunnanExtent, {
              padding: [20, 20, 20, 20],
              duration: 600
            });
            return;
          }
          
          // 加载市边界文件 - 修复路径为 "Shi" 而不是 "Shi84"
          const cityPath = `json/Shi/${cityName}.json`;
          loadVectorLayer(cityPath, 'city');
          
          const countyMapping = {
            '昆明市': ['五华区', '盘龙区', '官渡区', '西山区', '东川区', '呈贡区', '晋宁区', '富民县', '宜良县', '石林彝族自治县', '嵩明县', '禄劝彝族苗族自治县', '寻甸回族彝族自治县', '安宁市'],
            '曲靖市': ['麒麟区', '沾益区', '马龙区', '陆良县', '师宗县', '罗平县', '富源县', '会泽县', '宣威市'],
            '玉溪市': ['红塔区', '江川区', '澄江县', '通海县', '华宁县', '易门县', '峨山彝族自治县', '新平彝族傣族自治县', '元江哈尼族彝族傣族自治县'],
            '保山市': ['隆阳区', '施甸县', '龙陵县', '昌宁县', '腾冲市'],
            '昭通市': ['昭阳区', '鲁甸县', '巧家县', '盐津县', '大关县', '永善县', '绥江县', '镇雄县', '彝良县', '威信县', '水富市'],
            '丽江市': ['古城区', '玉龙纳西族自治县', '永胜县', '华坪县', '宁蒗彝族自治县'],
            '普洱市': ['思茅区', '宁洱哈尼族彝族自治县', '墨江哈尼族自治县', '景东彝族自治县', '景谷傣族彝族自治县', '镇沅彝族哈尼族拉祜族自治县', '江城哈尼族彝族自治县', '孟连傣族拉祜族佤族自治县', '澜沧拉祜族自治县', '西盟佤族自治县'],
            '临沧市': ['临翔区', '凤庆县', '云县', '永德县', '镇康县', '双江拉祜族佤族布朗族傣族自治县', '耿马傣族佤族自治县', '沧源佤族自治县'],
            '楚雄彝族自治州': ['楚雄市', '双柏县', '牟定县', '南华县', '姚安县', '大姚县', '永仁县', '元谋县', '武定县', '禄丰县'],
            '红河哈尼族彝族自治州': ['个旧市', '开远市', '蒙自市', '弥勒市', '屏边苗族自治县', '建水县', '石屏县', '泸西县', '元阳县', '红河县', '金平苗族瑶族傣族自治县', '绿春县', '河口瑶族自治县'],
            '文山壮族苗族自治州': ['文山市', '砚山县', '西畴县', '麻栗坡县', '马关县', '丘北县', '广南县', '富宁县'],
            '西双版纳傣族自治州': ['景洪市', '勐海县', '勐腊县'],
            '大理白族自治州': ['大理市', '漾濞彝族自治县', '祥云县', '宾川县', '弥渡县', '南涧彝族自治县', '巍山彝族回族自治县', '永平县', '云龙县', '洱源县', '剑川县', '鹤庆县'],
            '德宏傣族景颇族自治州': ['瑞丽市', '芒市', '梁河县', '盈江县', '陇川县'],
            '怒江傈僳族自治州': ['泸水市', '福贡县', '贡山独龙族怒族自治县', '兰坪白族普米族自治县'],
            '迪庆藏族自治州': ['香格里拉市', '德钦县', '维西傈僳族自治县']
          };
          
          if (countyMapping[cityName]) {
            countyMapping[cityName].forEach(county => {
              const option = document.createElement('option');
              option.value = county;
              option.textContent = county;
              countySelect.appendChild(option);
            });
          }
        });

        // 6. 监听县变化
        countySelect.addEventListener('change', () => {
          const countyName = countySelect.options[countySelect.selectedIndex].text.trim();
          
          if (!countyName) {
            // 县为空 -> 回到当前市范围
            const cityName = citySelect.options[citySelect.selectedIndex].text.trim();
            if (cityName) {
              // 修复路径为 "Shi" 而不是 "Shi84"
              const cityPath = `json/Shi/${cityName}.json`;
              loadVectorLayer(cityPath, 'city');
            }
            return;
          }
          
          // 加载县边界文件 - 修复路径为 "Xian" 而不是 "Xian84"
          const countyPath = `json/Xian/${countyName}.json`;
          loadVectorLayer(countyPath, 'county');
        });
        
      } catch (error) {
        console.error("地图初始化失败:", error);
        document.getElementById("yunnanMap").innerHTML = `
          <div class="map-error">
            <p>地图初始化失败</p>
            <p>${error.message}</p>
            <p>请确保已加载 GeoTIFF 库</p>
          </div>
        `;
      }
    });
</script>

    <script>
      // 更新时间显示
      document
        .getElementById("timeSlider")
        .addEventListener("input", function () {
          document.querySelector(".time-label").textContent = this.value + "年";
        });

      let fvcData = [];

      function initCoverageLineChart() {
        const chartDom = document.getElementById("coverageLineChart");
        if (!chartDom) return;

        const myChart = echarts.init(chartDom);

        // 加载CSV
        Papa.parse("fvc_data.csv", {
          download: true,
          header: true,
          complete: function (results) {
            fvcData = results.data.filter(
              (d) => d.region_id && d.year && d.fvc_mean
            );
            // 默认显示云南省
            updateFVCChart("530000");
          },
          error: function (error) {
            console.error("CSV加载失败:", error);
            chartDom.innerHTML = '<p class="error-msg">FVC数据加载失败</p>';
          },
        });

        // 点击搜索按钮后更新
        document
          .getElementById("region-search-btn")
          .addEventListener("click", function () {
            const cityCode = document.getElementById("city-select").value;
            const countyCode = document.getElementById("county-select").value;
            const selectedCode = countyCode || cityCode || "530000";
            updateFVCChart(selectedCode);
          });

        function updateFVCChart(regionCode) {
          const filtered = fvcData.filter((d) => d.region_id === regionCode);
          if (!filtered.length) {
            myChart.setOption({ series: [{ data: [] }] });
            return;
          }

          filtered.sort((a, b) => a.year - b.year);
          const years = filtered.map((d) => d.year);
          const values = filtered.map((d) => parseFloat(d.fvc_mean));
          const regionName = filtered[0]?.region_name || "未知区域";

          myChart.setOption({
            tooltip: {
              trigger: "axis",
              formatter: (p) => `${p[0].axisValue}年: ${p[0].data.toFixed(4)}`,
            },
            xAxis: {
              type: "category",
              data: years,
              axisLabel: { rotate: 45 },
            },
            yAxis: {
              type: "value",
              min: 0,
              max: 1,
              axisLabel: { formatter: (v) => v.toFixed(2) },
            },
            series: [
              {
                data: values,
                type: "line",
                smooth: true,
                symbol: "circle",
                symbolSize: 6,
                lineStyle: { width: 3, color: "#4CAF50" },
                itemStyle: { color: "#4CAF50" },
                areaStyle: {
                  color: new echarts.graphic.LinearGradient(0, 0, 0, 1, [
                    { offset: 0, color: "rgba(76, 175, 80, 0.3)" },
                    { offset: 1, color: "rgba(76, 175, 80, 0.1)" },
                  ]),
                },
                markPoint: {
                  data: [
                    { type: "max", name: "最大值" },
                    { type: "min", name: "最小值" },
                  ],
                },
                markLine: {
                  data: [{ type: "average", name: "平均值" }],
                },
              },
            ],
            grid: {
              left: "0%",
              right: "10%",
              bottom: "10%",
              top: 30,
              containLabel: true,
            },
          });
        }

        window.addEventListener("resize", () => myChart.resize());
      }
      // 页面加载完成后初始化图表
      document.addEventListener("DOMContentLoaded", function () {
        initCoverageLineChart();
      });

      
    </script>
    <script src="js/year-ragion.js"></script>

</body>
</html>
